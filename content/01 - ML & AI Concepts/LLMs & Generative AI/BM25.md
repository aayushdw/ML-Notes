**BM25** scores how well a document matches a query.

$$BM25(D, Q) = \sum_{q \in Q} IDF(q) \cdot \frac{TF(q, D) \cdot (k_1 + 1)}{TF(q, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{avgdl})}$$

---
## Part 1: IDF (Inverse Document Frequency)

Measures how rare/important a word is.

$$IDF(q) = \log\left(\frac{N - n_q + 0.5}{n_q + 0.5}\right)$$
Where:
- $N$ = total documents in corpus
- $n_q$ = documents containing word $q$
**Example**:
- Word "the" appears in 1,000,000 out of 1,000,000 docs → IDF ≈ -7 (useless, penalized)
- Word "transformer" appears in 50 out of 1,000,000 docs → IDF ≈ 9.9 (very useful, boosted)

Common words (the, and, is) get low or negative scores. Rare, meaningful words get high scores.

---

## Part 2: TF Component (Term Frequency with Saturation)

Counts how many times the word appears in the document, but with diminishing returns.

$$\frac{TF(q, D) \cdot (k_1 + 1)}{TF(q, D) + k_1}$$
Where:
- $TF(q, D)$ = count of word $q$ in document $D$
- $k_1$ = saturation parameter (default 1.2)

If a doc mentions "AI" 1 time vs 100 times, the 100-time doc isn't 100x more relevant. Repetition has diminishing returns.

---

## Part 3: Length Normalization

Fairness adjustment so long documents don't always win.

$$1 - b + b \cdot \frac{|D|}{avgdl}$$
Where:
- $b$ = normalization strength (default 0.75)
- $|D|$ = length of document (word count)
- $avgdl$ = average document length in corpus

A long document naturally has more word matches. But a short article specifically *about* a topic is more relevant than a passing mention in a textbook.

**Example with $b = 0.75$, $avgdl = 200$**:

| Doc Length        | Calculation                  | Result     | Effect                                   |
| ----------------- | ---------------------------- | ---------- | ---------------------------------------- |
| 50 words (short)  | 1 - 0.75 + 0.75 × (50/200)   | **0.4375** | Gets boosted (divide by smaller number)  |
| 100 words         | 1 - 0.75 + 0.75 × (100/200)  | **0.625**  | Slight boost                             |
| 200 words (avg)   | 1 - 0.75 + 0.75 × (200/200)  | **1.0**    | Baseline (no change)                     |
| 500 words         | 1 - 0.75 + 0.75 × (500/200)  | **2.125**  | Gets penalized (divide by larger number) |
| 1000 words (long) | 1 - 0.75 + 0.75 × (1000/200) | **3.75**   | Heavily penalized                        |

---
## Putting It All Together

**Full TF+Length formula** (the denominator):

$$TF(q, D) + k_1 \cdot \left(1 - b + b \cdot \frac{|D|}{avgdl}\right)$$
This combines:
- **Saturation**: TF stops growing fast
- **Length penalty**: Longer docs get bigger denominators

**Final calculation for each query word**:

$$IDF(q) \cdot \frac{TF(q, D) \cdot (k_1 + 1)}{TF(q, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{avgdl})}$$

**Then sum** across all query words to get the total BM25 score.

---
## Parameter Guide

| Parameter | Default | Range     | Effect                                                     |
| --------- | ------- | --------- | ---------------------------------------------------------- |
| **$k_1$** | 1.2     | 0.5 - 2.0 | Lower = ignore repetition; Higher = reward repetition more |
| **$b$**   | 0.75    | 0.0 - 1.0 | 0 = ignore length; 1.0 = heavily penalize long docs        |

**Common values**:
- $k_1 = 1.2, b = 0.75$ → Default (balanced)
- $k_1 = 2.0, b = 0.75$ → More repetition weight (for verbose docs)
- $k_1 = 1.2, b = 0.0$ → Ignore document length (when length is irrelevant)

